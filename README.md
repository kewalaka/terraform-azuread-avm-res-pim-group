<!-- BEGIN_TF_DOCS -->
<!-- Code generated by terraform-docs. DO NOT EDIT. -->
# terraform-azuread-avm-ptn-pim-group

A module in the style of Azure Verified Modules for managing an Entra ID Privileged Identity Management (PIM) group.

The original intention was to use the `msgraph` provider, however blocking issues were identified.

Instead, this approach uses the traditional `azuread` provider from Hashicorp for the group and PIM resources.

An experimental `msgraph` approach which records the current status of issues is available here:
<https://github.com/kewalaka/terraform-msgraph-avm-ptn-pim-group>

## Graph Permissions (Minimum Application Permissions)

| Capability | Permissions |
|------------|-------------|
| Create / Update Group | `Group.ReadWrite.All`, `Directory.ReadWrite.All` |
| Role-Assignable Group | `RoleManagement.ReadWrite.Directory` |
| Group PIM Eligibility Requests | `PrivilegedAccess.ReadWrite.AzureADGroup` |

## Technical notes

### Coverage

The module supports the following as illustrated by examples:

- **Eligible Users** ("PIM for groups").  This is the recommended approach for most scenarios, where a group is permanently assigned the role and users are eligible to request access to this group.  This provides per-user visibility for activation requests.

- **Group-Assignable**.  In this approach the group is activated into the role rather than an individual user.  This is not recommended except for specific circumstances (Microsoft recommend this approach for some M365 portals).  Further details and a comparison with "PIM for groups" are in the example [README.md](examples/group-eligible/README.md).

- **Eligible for Entra Roles**.  This is the same as the eligible users approach except designed to be used directly against Entra Roles.

### Ownership Enforcement

Role-assignable groups must declare at least one owner via `group_settings.owners` or `group_default_owner_object_ids`; enforced with resource lifecycle precondition.

### Role Definition Resolution Pattern

Name→ID resolution handled by helper module mapping; IDs pass through unchanged. Fallback preserves user-supplied value if unmapped (supports custom roles defined at narrower scopes if user supplies full ID).

<!-- markdownlint-disable MD033 -->
## Requirements

The following requirements are needed by this module:

- <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) (>= 1.9, < 2.0)

- <a name="requirement_azapi"></a> [azapi](#requirement\_azapi) (~> 2.7)

- <a name="requirement_azuread"></a> [azuread](#requirement\_azuread) (~> 3.0)

- <a name="requirement_modtm"></a> [modtm](#requirement\_modtm) (~> 0.3)

- <a name="requirement_random"></a> [random](#requirement\_random) (~> 3.5)

## Resources

The following resources are used by this module:


- [azuread_group.this](https://registry.terraform.io/providers/hashicorp/azuread/latest/docs/resources/group) (resource)
- [azuread_group_role_management_policy.this](https://registry.terraform.io/providers/hashicorp/azuread/latest/docs/resources/group_role_management_policy) (resource)
- [azuread_privileged_access_group_eligibility_schedule.this](https://registry.terraform.io/providers/hashicorp/azuread/latest/docs/resources/privileged_access_group_eligibility_schedule) (resource)
- [modtm_telemetry.telemetry](https://registry.terraform.io/providers/azure/modtm/latest/docs/resources/telemetry) (resource)

- [random_uuid.telemetry](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/uuid) (resource)
- [azapi_client_config.telemetry](https://registry.terraform.io/providers/Azure/azapi/latest/docs/data-sources/client_config) (data source)
- [modtm_module_source.telemetry](https://registry.terraform.io/providers/azure/modtm/latest/docs/data-sources/module_source) (data source)

<!-- markdownlint-disable MD013 -->
## Required Inputs

The following input variables are required:

### <a name="input_name"></a> [name](#input\_name)

Description: The display name for the Entra ID group.

Type: `string`

## Optional Inputs

The following input variables are optional (have default values):

### <a name="input_allow_role_assignable_group_without_owner"></a> [allow\_role\_assignable\_group\_without\_owner](#input\_allow\_role\_assignable\_group\_without\_owner)

Description: Allows creation of a role-assignable group without any owners. Not recommended.

Why: Owners provide delegated recovery and governance for privileged groups.  
Leaving a role-assignable group ownerless can impede lifecycle management and  
reduce accountability.

References:
- Microsoft Graph group (isAssignableToRole): https://learn.microsoft.com/graph/api/resources/group?view=graph-rest-1.0
- Assign Azure roles using groups: https://learn.microsoft.com/azure/role-based-access-control/role-assignments-group
- Privileged access groups (PIM): https://learn.microsoft.com/entra/id-governance/privileged-identity-management/groups-features

Set to true only if you fully understand and accept the risk.

Type: `bool`

Default: `false`



### <a name="input_eligible_member_schedules"></a> [eligible\_member\_schedules](#input\_eligible\_member\_schedules)

Description: Advanced configuration for eligible member schedules. Keys should be unique identifiers for each schedule.

Type:

```hcl
map(object({
    principal_id         = string
    group_id             = optional(string)
    assignment_type      = optional(string)
    duration             = optional(string)
    expiration_date      = optional(string)
    start_date           = optional(string)
    justification        = optional(string)
    permanent_assignment = optional(bool)
    ticket_number        = optional(string)
    ticket_system        = optional(string)
    enabled              = optional(bool)
    timeouts = optional(object({
      create = optional(string)
      read   = optional(string)
      update = optional(string)
      delete = optional(string)
    }))
  }))
```

Default: `{}`

### <a name="input_eligible_members"></a> [eligible\_members](#input\_eligible\_members)

Description: A list of principal IDs to be made eligible for membership in the group.

Type: `list(string)`

Default: `[]`

### <a name="input_enable_telemetry"></a> [enable\_telemetry](#input\_enable\_telemetry)

Description: This variable controls whether or not telemetry is enabled for the module.  
For more information see <https://aka.ms/avm/telemetryinfo>.  
If it is set to false, then no telemetry will be collected.

Type: `bool`

Default: `true`

### <a name="input_group_default_owner_object_ids"></a> [group\_default\_owner\_object\_ids](#input\_group\_default\_owner\_object\_ids)

Description: Fallback list of owner object IDs when group\_settings.owners is not specified. Provide at least one for role-assignable groups.

Type: `list(string)`

Default: `[]`

### <a name="input_group_description"></a> [group\_description](#input\_group\_description)

Description: A description for the Entra ID group.

Type: `string`

Default: `""`

### <a name="input_group_settings"></a> [group\_settings](#input\_group\_settings)

Description: Optional settings applied to the Entra ID group beyond the baseline configuration.

## Role-Assignable Groups (`assignable_to_role`)

Role-assignable groups have special properties and limitations that should be considered:

### When Role-Assignable is REQUIRED:
- **Entra ID Role Assignment**: If you want to assign Entra ID (directory) roles to a group, it MUST be role-assignable.  
  The `assignable_to_role` property must be set at group creation and cannot be changed afterward.

### When Role-Assignable is RECOMMENDED:
- **Critical Resources**: For groups providing access to sensitive resources, role-assignable groups offer enhanced security:
  - Only Global Administrator, Privileged Role Administrator, or the group Owner can manage the group
  - Only these privileged roles can modify credentials of active group members
  - Prevents privilege escalation by lower-privileged administrators (e.g., Helpdesk Administrator cannot reset passwords of members)

### Important Limitations:
- **500 Group Limit**: Maximum of 500 role-assignable groups per tenant (hard limit)
- **No Nesting**: Role-assignable groups cannot contain other groups as members
- **Immutable Property**: Cannot be changed after group creation
- **Planning Required**: In large environments with many PIM-enabled groups, reserve role-assignable groups for:
  - Groups that need Entra ID role assignments
  - Groups providing access to highly privileged resources
  - Consider using non-role-assignable groups for less critical PIM scenarios (subscription-level access, etc.)

### PIM for Groups Compatibility:
- **Any security group or Microsoft 365 group can use PIM for Groups** (except dynamic membership groups and on-premises synced groups)
- Role-assignable groups are NOT required for PIM for Groups functionality
- This restriction was removed in January 2023, allowing more than 500 PIM-enabled groups per tenant

### Sources:
- [Relationship between role-assignable groups and PIM for Groups](https://learn.microsoft.com/en-us/entra/id-governance/privileged-identity-management/concept-pim-for-groups#relationship-between-role-assignable-groups-and-pim-for-groups)
- [What are Microsoft Entra role-assignable groups?](https://learn.microsoft.com/en-us/entra/id-governance/privileged-identity-management/concept-pim-for-groups#what-are-microsoft-entra-role-assignable-groups)
- [Create a role-assignable group in Microsoft Entra ID](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/groups-create-eligible)

Type:

```hcl
object({
    administrative_unit_ids    = optional(list(string))
    assignable_to_role         = optional(bool)
    auto_subscribe_new_members = optional(bool)
    behaviors                  = optional(list(string))
    description                = optional(string)
    external_senders_allowed   = optional(bool)
    hide_from_address_lists    = optional(bool)
    hide_from_outlook_clients  = optional(bool)
    mail_enabled               = optional(bool)
    mail_nickname              = optional(string)
    owners                     = optional(list(string))
    prevent_duplicate_names    = optional(bool)
    provisioning_options       = optional(list(string))
    security_enabled           = optional(bool)
    theme                      = optional(string)
    types                      = optional(list(string))
    visibility                 = optional(string)
    dynamic_membership = optional(object({
      rule             = string
      processing_state = optional(string, "On")
    }))
    timeouts = optional(object({
      create = optional(string)
      read   = optional(string)
      update = optional(string)
      delete = optional(string)
    }))
  })
```

Default: `{}`

### <a name="input_pim_activation_max_duration"></a> [pim\_activation\_max\_duration](#input\_pim\_activation\_max\_duration)

Description: The maximum duration for which a PIM group membership can be activated. Should be an ISO 8601 duration string (e.g., 'PT8H' for 8 hours).

**IMPORTANT**: Due to a bug in the msgraph Terraform provider (https://github.com/microsoft/terraform-provider-msgraph/issues/75),  
changing this value from the Microsoft default (PT8H) will cause persistent drift. The provider reports successful updates  
but the API does not persist the changes. Until the provider is fixed, use the default value to avoid drift.

Type: `string`

Default: `"PT8H"`

### <a name="input_pim_approver_object_ids"></a> [pim\_approver\_object\_ids](#input\_pim\_approver\_object\_ids)

Description: A list of object IDs for principals who can approve PIM activation requests. Only used if pim\_require\_approval\_on\_activation is true.

Type: `list(string)`

Default: `[]`

### <a name="input_pim_approver_object_type"></a> [pim\_approver\_object\_type](#input\_pim\_approver\_object\_type)

Description: The approver object type supplied to the policy. Use 'singleUser' for individual users or 'groupMembers' for Entra ID groups.

Type: `string`

Default: `"singleUser"`

### <a name="input_pim_eligibility_duration"></a> [pim\_eligibility\_duration](#input\_pim\_eligibility\_duration)

Description: The ISO8601 duration that an eligibility assignment remains valid (e.g., 'P365D').

**IMPORTANT**: Due to a bug in the msgraph Terraform provider (https://github.com/microsoft/terraform-provider-msgraph/issues/75),  
changing this value from the Microsoft default (P365D) will cause persistent drift. The provider reports successful updates  
but the API does not persist the changes. Until the provider is fixed, use the default value to avoid drift.

Type: `string`

Default: `"P365D"`

### <a name="input_pim_policy_settings"></a> [pim\_policy\_settings](#input\_pim\_policy\_settings)

Description: Overrides for the azuread\_group\_role\_management\_policy resource. Provide blocks to fully customise policy behaviour; omit or set empty lists to fall back to sensible defaults.

Type:

```hcl
object({
    role_id = optional(string)
    eligible_assignment_rules = optional(list(object({
      expiration_required = optional(bool)
      expire_after        = optional(string)
    })))
    active_assignment_rules = optional(list(object({
      expiration_required                = optional(bool)
      expire_after                       = optional(string)
      require_multifactor_authentication = optional(bool)
      require_justification              = optional(bool)
      require_ticket_info                = optional(bool)
    })))
    activation_rules = optional(list(object({
      maximum_duration                                   = optional(string)
      require_multifactor_authentication                 = optional(bool)
      require_approval                                   = optional(bool)
      require_justification                              = optional(bool)
      require_ticket_info                                = optional(bool)
      required_conditional_access_authentication_context = optional(string)
      approval_stage = optional(list(object({
        primary_approver = optional(set(object({
          object_id = string
          type      = optional(string)
        })))
      })))
    })))
    notification_rules = optional(list(object({
      eligible_assignments = optional(list(object({
        admin_notifications = optional(list(object({
          default_recipients    = bool
          notification_level    = string
          additional_recipients = optional(set(string))
        })))
        approver_notifications = optional(list(object({
          default_recipients    = bool
          notification_level    = string
          additional_recipients = optional(set(string))
        })))
        assignee_notifications = optional(list(object({
          default_recipients    = bool
          notification_level    = string
          additional_recipients = optional(set(string))
        })))
      })))
      eligible_activations = optional(list(object({
        admin_notifications = optional(list(object({
          default_recipients    = bool
          notification_level    = string
          additional_recipients = optional(set(string))
        })))
        approver_notifications = optional(list(object({
          default_recipients    = bool
          notification_level    = string
          additional_recipients = optional(set(string))
        })))
        assignee_notifications = optional(list(object({
          default_recipients    = bool
          notification_level    = string
          additional_recipients = optional(set(string))
        })))
      })))
      active_assignments = optional(list(object({
        admin_notifications = optional(list(object({
          default_recipients    = bool
          notification_level    = string
          additional_recipients = optional(set(string))
        })))
        approver_notifications = optional(list(object({
          default_recipients    = bool
          notification_level    = string
          additional_recipients = optional(set(string))
        })))
        assignee_notifications = optional(list(object({
          default_recipients    = bool
          notification_level    = string
          additional_recipients = optional(set(string))
        })))
      })))
    })))
  })
```

Default: `{}`

### <a name="input_pim_require_approval_on_activation"></a> [pim\_require\_approval\_on\_activation](#input\_pim\_require\_approval\_on\_activation)

Description: Whether approval is required to activate PIM group membership. Should be false for automation.

Type: `bool`

Default: `false`

### <a name="input_pim_require_mfa_on_activation"></a> [pim\_require\_mfa\_on\_activation](#input\_pim\_require\_mfa\_on\_activation)

Description: Whether MFA is required to activate PIM group membership.

Type: `bool`

Default: `true`



## Outputs

The following outputs are exported:





### <a name="output_group_id"></a> [group\_id](#output\_group\_id)

Description: The ID of the created Entra ID group (Microsoft Graph group id).

### <a name="output_group_object_id"></a> [group\_object\_id](#output\_group\_object\_id)

Description: The Object ID of the created Entra ID group (same as group\_id).

### <a name="output_resource_id"></a> [resource\_id](#output\_resource\_id)

Description: The Azure resource ID of the Entra ID group. This output is required by Azure Verified Modules specification RMFR7.



<!-- markdownlint-disable-next-line MD041 -->
## Data Collection

The software may collect information about you and your use of the software and send it to Microsoft. Microsoft may use this information to provide services and improve our products and services. You may turn off the telemetry as described in the repository. There are also some features in the software that may enable you and Microsoft to collect data from users of your applications. If you use these features, you must comply with applicable law, including providing appropriate notices to users of your applications together with a copy of Microsoft’s privacy statement. Our privacy statement is located at <https://go.microsoft.com/fwlink/?LinkID=824704>. You can learn more about data collection and use in the help documentation and our privacy statement. Your use of the software operates as your consent to these practices.
<!-- END_TF_DOCS -->